name: Tests

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
  issue_comment:
    types: [created]

permissions:
  contents: read

jobs:
  prepare:
    name: Prepare CI
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'issue_comment' ||
      (github.event.issue.pull_request && github.event.comment.body == '/ci:full')
    outputs:
      run_full_matrix: ${{ steps.check.outputs.run_full_matrix }}
      pr_head_sha: ${{ steps.check.outputs.pr_head_sha }}
      pr_head_repo: ${{ steps.check.outputs.pr_head_repo }}
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Determine matrix type
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName;
            let runFullMatrix = false;
            let shouldRun = true;
            let prHeadSha = '';
            let prHeadRepo = '';

            if (eventName === 'push' && context.ref === 'refs/heads/main') {
              runFullMatrix = true;
            } else if (eventName === 'workflow_dispatch') {
              runFullMatrix = true;
            } else if (eventName === 'issue_comment') {
              // Already filtered by job-level if, so this is /ci:full on a PR
              runFullMatrix = true;

              // Fetch PR details to get the head SHA and repo
              const prNumber = context.issue.number;
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });

              prHeadSha = pr.head.sha;
              prHeadRepo = pr.head.repo.full_name;
            }
            // pull_request event: runFullMatrix stays false (minimal matrix)

            core.setOutput('run_full_matrix', runFullMatrix.toString());
            core.setOutput('pr_head_sha', prHeadSha);
            core.setOutput('pr_head_repo', prHeadRepo);
            core.setOutput('should_run', shouldRun.toString());

  skip_duplicate_runs:
    needs: [prepare]
    if: needs.prepare.outputs.should_run == 'true'
    uses: ./.github/workflows/skip_duplicate_workflow_runs.yml

  rubocop:
    name: RuboCop linting
    needs: [prepare]
    if: needs.prepare.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.pr_head_sha || github.sha }}
          repository: ${{ needs.prepare.outputs.pr_head_repo || github.repository }}
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1
          bundler-cache: true
      - name: rubocop
        run: bundle exec rake rubocop

  test_mri_minimal:
    name: >-
      ${{ matrix.os }} ${{ matrix.ruby }} (minimal)
    needs: [prepare, rubocop, skip_duplicate_runs]
    if: |
      needs.prepare.outputs.should_run == 'true' &&
      needs.prepare.outputs.run_full_matrix != 'true' &&
      !(   contains(github.event.pull_request.title,  '[ci skip]')
        || contains(github.event.pull_request.title,  '[skip ci]'))
    env:
      CI: true
      PUMA_TEST_DEBUG: true
      TESTOPTS: -v
      PUMA_NO_RUBOCOP: true

    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-24.04]
        ruby: ['4.0']

    steps:
      - name: repo checkout
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.pr_head_sha || github.sha }}
          repository: ${{ needs.prepare.outputs.pr_head_repo || github.repository }}

      - name: load ruby
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        uses: ruby/setup-ruby-pkgs@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          apt-get: ragel
          brew: ragel
          rubygems: default
          bundler: default
          bundler-cache: true
          cache-version: tests
        timeout-minutes: 10

      - name: Repo & Commit Info
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        run: ruby .github/workflows/github_actions_info.rb

      - name: set WERRORFLAG
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        shell: bash
        run: echo 'PUMA_MAKE_WARNINGS_INTO_ERRORS=true' >> $GITHUB_ENV

      - name: compile
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        run: bundle exec rake compile

      - name: test
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        timeout-minutes: 10
        run: test/runner --verbose
        env:
          MT_CPU: 2

  test_mri:
    name: >-
      ${{ matrix.os }} ${{ matrix.ruby }}${{ matrix.no-ssl }}${{ matrix.yjit }}${{ matrix.rack-v }}
    needs: [prepare, rubocop, skip_duplicate_runs]
    if: |
      needs.prepare.outputs.should_run == 'true' &&
      needs.prepare.outputs.run_full_matrix == 'true' &&
      !(   contains(github.event.pull_request.title,  '[ci skip]')
        || contains(github.event.pull_request.title,  '[skip ci]'))
    env:
      CI: true
      PUMA_TEST_DEBUG: true
      TESTOPTS: -v
      PUMA_NO_RUBOCOP: true

    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-22.04, ubuntu-24.04, ubuntu-24.04-arm,
              macos-14, macos-15, macos-15-intel, macos-26,
              windows-2022 ]
        ruby: [ '3.0', 3.1, 3.2, 3.3, 3.4, '4.0' ]
        no-ssl: ['']
        rack-v: ['']
        yjit: ['']
        include:
          - { os: windows-2025    , ruby:  ucrt }
          - { os: windows-2025    , ruby:  mswin }
          - { os: windows-2025    , ruby: '3.0' , no-ssl: ' no SSL' }
          - { os: windows-11-arm  , ruby:  3.4 }
          - { os: ubuntu-22.04    , ruby:  3.2  , no-ssl: ' no SSL' }
          - { os: ubuntu-22.04    , ruby: '3.0' , rack-v: ' rack2'  }

        exclude:
          - { os: ubuntu-24.04    , ruby: '3.0' }
          - { os: ubuntu-24.04-arm, ruby:  3.1  }
          - { os: ubuntu-24.04-arm, ruby:  3.3  }
          - { os: macos-14        , ruby: '3.0' }
          - { os: macos-14        , ruby:  3.2  }
          - { os: macos-14        , ruby:  3.4  }
          - { os: macos-15        , ruby:  3.1  }
          - { os: macos-15        , ruby:  3.3  }
          - { os: macos-15-intel  , ruby: '3.0' }
          - { os: macos-15-intel  , ruby:  3.2  }
          - { os: macos-15-intel  , ruby:  3.4  }
          - { os: macos-26        , ruby: '3.0' }
          - { os: macos-26        , ruby:  3.2  }

    steps:
      - name: repo checkout
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.pr_head_sha || github.sha }}
          repository: ${{ needs.prepare.outputs.pr_head_repo || github.repository }}

      - name: Compile Puma without SSL support
        if: |
          (matrix.no-ssl == ' no SSL') &&
          (needs.skip_duplicate_runs.outputs.should_skip != 'true')
        shell: bash
        run: echo 'PUMA_DISABLE_SSL=true' >> $GITHUB_ENV

      - name: Set Rack version, see Gemfile
        shell: bash
        run: echo 'PUMA_CI_RACK=${{ matrix.rack-v }}' >> $GITHUB_ENV

      - name: load ruby
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        uses: ruby/setup-ruby-pkgs@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          apt-get: ragel
          brew: ragel
          rubygems: default
          bundler: default
          bundler-cache: true
          cache-version: tests
        timeout-minutes: 10

      - name: Repo & Commit Info
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        run: ruby .github/workflows/github_actions_info.rb

      - name: set WERRORFLAG
        if: |
          (needs.skip_duplicate_runs.outputs.should_skip != 'true') &&
          !(contains(matrix.os, 'ubuntu') && contains(matrix.os, 'arm'))
        shell: bash
        run: echo 'PUMA_MAKE_WARNINGS_INTO_ERRORS=true' >> $GITHUB_ENV

      - name: compile
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        run:  bundle exec rake compile

      - name: Use yjit
        if: |
          (matrix.yjit == ' yjit') &&
          (needs.skip_duplicate_runs.outputs.should_skip != 'true')
        shell: bash
        run: echo 'RUBYOPT=--yjit' >> $GITHUB_ENV

      - name: test
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        timeout-minutes: 10
        run: test/runner --verbose
        env:
          MT_CPU: 2

  test_non_mri:
    name: >-
      ${{ matrix.os }} ${{ matrix.ruby }}${{ matrix.no-ssl }}
    needs: [prepare, rubocop, skip_duplicate_runs]
    if: |
      needs.prepare.outputs.should_run == 'true' &&
      needs.prepare.outputs.run_full_matrix == 'true' &&
      !(   contains(github.event.pull_request.title,  '[ci skip]')
        || contains(github.event.pull_request.title,  '[skip ci]'))
    env:
      CI: true
      PUMA_TEST_DEBUG: true
      TESTOPTS: -v
      PUMA_NO_RUBOCOP: true

    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - { tto: 8 , os: ubuntu-22.04  , ruby: jruby }
          - { tto: 8 , os: ubuntu-22.04  , ruby: jruby, no-ssl: ' no SSL' }
          - { tto: 8 , os: ubuntu-22.04  , ruby: truffleruby }
          - { tto: 8 , os: ubuntu-24.04  , ruby: truffleruby }
          - { tto: 8 , os: macos-14      , ruby: jruby }
          - { tto: 8 , os: macos-15-intel, ruby: jruby }
          - { tto: 8 , os: macos-15      , ruby: truffleruby }

    steps:
      - name: repo checkout
        if: ${{ needs.skip_duplicate_runs.outputs.should_skip != 'true' }}
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.pr_head_sha || github.sha }}
          repository: ${{ needs.prepare.outputs.pr_head_repo || github.repository }}

      - name: load ruby, ragel
        if: ${{ needs.skip_duplicate_runs.outputs.should_skip != 'true' }}
        uses: ruby/setup-ruby-pkgs@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          apt-get: ragel
          brew: ragel
          rubygems: default
          bundler: default
          bundler-cache: true
        timeout-minutes: 10

      - name: Compile Puma without SSL support
        if: |
          (matrix.no-ssl == ' no SSL') &&
          (needs.skip_duplicate_runs.outputs.should_skip != 'true')
        shell: bash
        run: echo 'PUMA_DISABLE_SSL=true' >> $GITHUB_ENV

      - name: set WERRORFLAG
        if: ${{ needs.skip_duplicate_runs.outputs.should_skip != 'true' }}
        shell: bash
        run: echo 'PUMA_MAKE_WARNINGS_INTO_ERRORS=true' >> $GITHUB_ENV

      - name: compile
        if: ${{ needs.skip_duplicate_runs.outputs.should_skip != 'true' }}
        run:  bundle exec rake compile

      - name: test
        timeout-minutes: ${{ matrix.tto }}
        if: |
          success() &&
          (needs.skip_duplicate_runs.outputs.should_skip != 'true')
        run: test/runner --verbose
        env:
          MT_CPU: 2

  test_head:
    name: >-
      ${{ matrix.os }} ${{ matrix.ruby }}${{ matrix.yjit }} (HEAD)
    needs: [prepare, rubocop, skip_duplicate_runs]
    if: |
      needs.prepare.outputs.should_run == 'true' &&
      needs.prepare.outputs.run_full_matrix == 'true' &&
      !(   contains(github.event.pull_request.title,  '[ci skip]')
        || contains(github.event.pull_request.title,  '[skip ci]'))
    continue-on-error: true
    env:
      CI: true
      PUMA_TEST_DEBUG: true
      TESTOPTS: -v
      PUMA_NO_RUBOCOP: true

    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # CRuby HEAD
          - { os: ubuntu-22.04, ruby: head }
          - { os: ubuntu-24.04, ruby: head }
          - { os: ubuntu-24.04-arm, ruby: head }
          - { os: macos-14, ruby: head }
          - { os: macos-26, ruby: head }
          - { os: windows-2022, ruby: head }
          - { os: windows-11-arm, ruby: head }
          - { os: ubuntu-22.04, ruby: head, yjit: ' yjit' }
          # JRuby HEAD
          - { os: ubuntu-22.04, ruby: jruby-head }
          # TruffleRuby HEAD
          - { os: ubuntu-22.04, ruby: truffleruby-head }
          - { os: ubuntu-24.04, ruby: truffleruby-head }

    steps:
      - name: repo checkout
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        uses: actions/checkout@v6
        with:
          ref: ${{ needs.prepare.outputs.pr_head_sha || github.sha }}
          repository: ${{ needs.prepare.outputs.pr_head_repo || github.repository }}

      - name: load ruby
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        uses: ruby/setup-ruby-pkgs@v1
        with:
          ruby-version: ${{ matrix.ruby }}
          apt-get: ragel
          brew: ragel
          rubygems: default
          bundler: default
          bundler-cache: true
          cache-version: tests
        timeout-minutes: 10

      - name: Repo & Commit Info
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        run: ruby .github/workflows/github_actions_info.rb

      - name: set WERRORFLAG
        if: |
          (needs.skip_duplicate_runs.outputs.should_skip != 'true') &&
          !(contains(matrix.os, 'ubuntu') && contains(matrix.os, 'arm'))
        shell: bash
        run: echo 'PUMA_MAKE_WARNINGS_INTO_ERRORS=true' >> $GITHUB_ENV

      - name: compile
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        run: bundle exec rake compile

      - name: Use yjit
        if: |
          (matrix.yjit == ' yjit') &&
          (needs.skip_duplicate_runs.outputs.should_skip != 'true')
        shell: bash
        run: echo 'RUBYOPT=--yjit' >> $GITHUB_ENV

      - name: test
        if: needs.skip_duplicate_runs.outputs.should_skip != 'true'
        timeout-minutes: 10
        run: test/runner --verbose
        env:
          MT_CPU: 2
